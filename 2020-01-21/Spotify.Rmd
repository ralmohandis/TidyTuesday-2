---
title: "Spotify"
author: "Joel Soroos"
date: "January 28, 2020"
output: html_document
---

#Idea from Cal Webb: http://calumwebb.uk/posts/spotifyr/

#1.  Source data
```{r source, include=FALSE}
   knitr::opts_chunk$set(echo = TRUE)

   library(tidytuesdayR)
   library(janitor)

   tuesdata <- tidytuesdayR::tt_load('2020-01-21')
   songs_raw <- tuesdata$spotify_songs %>%
      clean_names()
   
```


#2a.  Isolate required fields, observations
```{r core data, warning = F, results = F, message = F, echo = T}

   library(tidyverse)  
   library(glue)
 
   songs <- songs_raw %>% 
      filter(
         !duplicated(paste(track_name, " - ", track_artist)),
         playlist_genre == "edm",
         track_popularity > 0
         ) %>% 
      mutate(
         #track_year = as.numeric(str_extract(track_album_release_date, "^.{4}")),
         track_name_artist = glue ('{track_name} - {track_artist}'),
         track_year = as.numeric(str_sub(track_album_release_date, 1,4)),
         track_rank = rank(-track_popularity)
         ) %>% 
      filter(track_rank < 20) %>%
      select(track_name_artist, danceability, energy, loudness, mode, speechiness, acousticness, instrumentalness, liveness, valence, tempo)

```


#2b.  Create distance matrix and clusters
```{r cluster, warning = F, results = F, message = F, echo = T}

   library (broom)

   songs_distance <- dist(songs)
   songs_distance_tidy <- tidy (songs_distance)
   
   songs_cluster <- hclust(songs_distance)
```

#2c.  Create dendogram components
```{r cluster, warning = F, results = F, message = F, echo = T}

   library(ggdendro)

   songs_dendro <- songs_cluster %>%
      as.dendrogram() %>%
      dendro_data(type = "triangle")
   
   songs_dendro_segment <- segment(songs_dendro)
   songs_dendro_label <- label(songs_dendro)
   songs_dendro_leaf_label <- leaf_label(songs_dendro)
```


#3.  Visualize
```{r visualize, warning = F, results = F, message = F, echo = T}
   
   ggplot() + 
      geom_segment(
         data = songs_dendro_segment,
         aes(x = x, y = y, xend = xend, yend = yend)
         ) + 
      geom_text(
         data = songs_dendro_label,
         aes(x = x, y = y, label = label, hjust = 0)
         ) +
      coord_flip() + 
      scale_y_reverse(expand = c(0.2, 0)) +
      theme_dendro() +
      ggsave ('songs.png')

```   