---
title: "French Trains"
author: "Joel Soroos"
date: "January 5, 2020"
output: html_document
---

#1.  Source data
```{r source, include=FALSE}
   knitr::opts_chunk$set(echo = TRUE)

   library(tidytuesdayR)
   library(janitor)
   library (showtext)

   tuesdata <- tidytuesdayR::tt_load('2019-02-26')
   trains_raw <- tuesdata$full_trains %>%
      clean_names()

   font_add_google("Gaegu")
   showtext_auto() 
```


#2a.  Isolate required fields, observations
```{r core data}

   library(tidyverse)  
 
   trains <- trains_raw %>%
      rename (
         trips = total_num_trips,
         journey_time = journey_time_avg,
         delay = avg_delay_all_arriving
         ) %>%
      select (year, month, departure_station, arrival_station, trips, journey_time, delay) %>%
      arrange (-delay) %>%
      filter (year == 2018)
```


#2b.  Compile unique stations (nodes)
```{r network}

   #unique departure stations
      departures <- trains %>%
         distinct(departure_station) %>%
         rename(station = departure_station)

   #unique arrival stations
      arrivals <- trains %>%
         distinct(arrival_station) %>%
         rename(station = arrival_station)

   #combined arrival/departures stations with unique station ID
      nodes <- full_join(departures, arrivals, by = "station") %>%
          rowid_to_column("id")
```   
 

#2c.  Create list of routes (edges)
```{r edges}

   #sum trips per route
      per_route <- trains %>%  
        group_by(departure_station, arrival_station) %>%
        summarise(trips = n()) %>% 
        ungroup()

   #append station ID to routes
      edges <- per_route %>% 
        left_join(nodes, by = c("departure_station" = "station")) %>% 
        rename(from = id) %>% 
        left_join(nodes, by = c("arrival_station" = "station")) %>% 
        rename(to = id) %>%
        select(from, to, trips)
```


#2d.  Combine nodes, edges into required format for network diagram
```{r}

   library(tidygraph)
   
   routes_tidy <- tbl_graph(nodes = nodes, edges = edges, directed = TRUE)
```


#3.  Visualize
```{r visualize, warning = F, results = F, message = F, echo = T}
   
   library(ggraph)
   
   ggraph(routes_tidy) +
      geom_edge_link(
         edge_color = "red"
      ) +
      geom_node_point() +
      geom_node_text(
         aes(label = station),
         size = 1, repel = TRUE
         ) +
      scale_edge_width(range = c(0.2, 2)) +
      theme_graph() +
      labs(
         title = "Train Delays in France",
         subtitle = " ",
         y = "# of Adoptable Dogs",
         caption = "Each node (point) is a train station. Each edge (line) is a route between stations.\nUniverse is adoptable dogs in U.S. on Petfinder.com as of September 9, 2019.\nVisualization: Joel Soroos @soroosj  |  Data: National Society of French Railways (SNCF) via R4DS Tidy Tuesday"
         )  +
      theme (
         plot.title = element_text(hjust = 0.5, vjust = 0, size = 11, face = "bold", margin = margin (0,0,5,0)),
         plot.title.position = "plot",
         plot.subtitle = element_text(hjust = 0.5, vjust = 0, size = 6, margin = margin (0,0,2,0)),
         plot.caption = element_text(hjust = 0, size = 6, face = "plain", margin = margin (5,0,0,0)),
         plot.caption.position = "plot",
         legend.position = "none",
         text = element_text(family = "Gaegu")
         ) +
      ggsave("trains.png", width = 14, height = 14, units = "cm")
```   
   
   




