---
title: "Penguins"
author: "Joel Soroos"
date: "9/30/2020"
output: html_document
---


```{r source, warning = FALSE, message = FALSE}

   library(tidyverse)
   library(janitor)
   library(palmerpenguins)
   library(knitr)

   penguins_raw <- read_csv(path_to_file("penguins_raw.csv")) %>%
      clean_names()
   
   opts_chunk$set(warning = FALSE, message = FALSE)
   
   #https://www.tidymodels.org/learn/statistics/k-means/
   #https://www.guru99.com/r-k-means-clustering.html
   #https://afit-r.github.io/kmeans_clustering
```


```{r explore}

   library(skimr)

   skim (penguins_raw)
```


```{r transform}

   penguins <- penguins_raw %>%
      rename (
         bill_length = culmen_length_mm,
         bill_depth = culmen_depth_mm,
         flipper_length = flipper_length_mm,
         body_mass = body_mass_g
         ) %>%
      mutate (
         id = row_number(),
         species = word (species, 1),
         bill_length = scale(bill_length),
         bill_depth = scale(bill_depth),
         flipper_length = scale(flipper_length),
         body_mass = scale(body_mass)
         ) %>%
      select (id, species, island, sex, bill_length, bill_depth, flipper_length, body_mass) %>%
      drop_na
```


```{r}

    library (GGally)

    ggpairs(
       data = penguins_raw,
       columns = c(10:14),
       diag = list(continuous = wrap("barDiag", colour = "blue")),
       upper = list(continuous = wrap("cor", size = 6))
         )
```


#Visualize potential clusters
```{r}

   library(factoextra)
   library(glue)

   kmeans_flex <- function (k) {
      penguins_kmeans <- kmeans(penguins[5:7], k) 
      fviz_cluster(penguins_kmeans, geom = "point", data = penguins[5:7]) +
      labs(title = glue("{k} clusters")) +
      theme (
         plot.title = element_text (margin = margin(0,0,5,0), hjust = 0.5, size = 15, family = "Lato"),
         plot.background = element_blank(),
         legend.text = element_text(hjust = 0, size = 13, family = "Lato")
         ) 
      }

   map (1:10, kmeans_flex)
```


#Identify optimal number of clusters.
```{r model}

   library(broom)
   library(here)
   
   set.seed(920)
   
   penguins_clust <- 
      tibble (k = 1:10) %>%
      mutate (
         cluster = map(k, ~kmeans(penguins[5:7], .x, nstart=25)),
         glanced = map(cluster, glance)
         ) %>%
      unnest (glanced) %>%
      select (-cluster) %>%
      clean_names %>%
      write_csv (here("2020-07-28","output", "model.csv")) %>%
      rename (
         total = totss,
         intra_cluster = tot_withinss,
         inter_cluster = betweenss
      ) %>%
      pivot_longer (
         cols = total:inter_cluster,
         names_to = "residual_type",
         values_to = "residual_sum"
      )
```


#Identify optimal number of clusters
```{r}

   ggplot (penguins_clust, aes(x = k, y= residual_sum, fill = residual_type)) +
      geom_col (data = penguins_clust %>% filter (residual_type != "total")) + 
      geom_line (data = penguins_clust %>% filter (residual_type == "intra_cluster")) 

   fviz_nbclust(penguins[5:7], kmeans, method = "wss") 
   
   fviz_nbclust(penguins[5:7], kmeans, method = "silhouette") 
```


#Copmpare optimized clusters relative to labeled data
```{r}
   penguins_kmeans_extended <- 
      kmeans(penguins[5:7], 2) %>%
      augment (penguins) %>%
      rename (cluster = .cluster) %>%
      select (cluster, species, island, sex, id)

   criteria <- c("species", "island", "sex")
   
   cluster_compare <- function (criteria) {
      penguins_kmeans_extended %>%
      count(criteria,cluster) %>%
      ggplot(aes(x=criteria, y=cluster, fill = n)) + 
         geom_tile() 
      }

   map (criteria,cluster_compare)
```