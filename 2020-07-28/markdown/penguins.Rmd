---
title: "Penguins"
author: "Joel Soroos"
date: "9/30/2020"
output: html_document
---


```{r source, warning = FALSE, message = FALSE}

   library(tidyverse)
   library(janitor)
   library(palmerpenguins)
   library(knitr)

   penguins_raw <- read_csv(path_to_file("penguins_raw.csv")) %>%
      clean_names()
   
   opts_chunk$set(warning = FALSE, message = FALSE)
   
   #https://www.tidymodels.org/learn/statistics/k-means/
   #https://www.guru99.com/r-k-means-clustering.html
   #https://afit-r.github.io/kmeans_clustering
```


```{r explore}

   library(skimr)
   library (GGally)

   skim (penguins_raw)
   
   ggpairs(
      data = penguins_raw,
      columns = c(10:14),
      diag = list(continuous = wrap("barDiag", colour = "blue")),
      upper = list(continuous = wrap("cor", size = 6))
         )
```


```{r transform}

   penguins <- penguins_raw %>%
      rename (
         bill_length = culmen_length_mm,
         bill_depth = culmen_depth_mm,
         flipper_length = flipper_length_mm,
         body_mass = body_mass_g
         ) %>%
      mutate (
         id = row_number(),
         species = word (species, 1),
         bill_length = scale(bill_length),
         bill_depth = scale(bill_depth),
         flipper_length = scale(flipper_length),
         body_mass = scale(body_mass)
         ) %>%
      select (id, species, island, sex, bill_length, bill_depth, flipper_length, body_mass) %>%
      drop_na
```


#Visualize potential clusters
```{r}

   library(factoextra)
   library(patchwork)
   library(glue)

   kmeans_flex <- function (k) {
      penguins_kmeans <- kmeans(penguins[5:7], k) 
      fviz_cluster(penguins_kmeans, geom = "point", data = penguins[5:7]) +
      labs(title = glue("{k} clusters")) +
      theme (
         plot.title = element_text (margin = margin(0,0,5,0), hjust = 0.5, size = 8, family = "Lato"),
         plot.background = element_blank(),
         legend.text = element_text(hjust = 0, size = 8, family = "Lato"),
         legend.position = "bottom",
         legend.title = element_text(size = 8),
         #legend.key.size = unit(0.5),
         axis.title = element_text (size = 8)
         ) 
      }

   cluster_possibles <- map (1:9, kmeans_flex)
   
   cluster_possibles[[1]] + cluster_possibles[2] + cluster_possibles[3] +
      cluster_possibles[[4]] + cluster_possibles[5] + cluster_possibles[6] +
      cluster_possibles[[7]] + cluster_possibles[8] + cluster_possibles[9]
   
```


#Identify optimal number of clusters
```{r}

   fviz_nbclust(penguins[5:7], kmeans, method = "wss") 
   
   fviz_nbclust(penguins[5:7], kmeans, method = "silhouette") 
```


#Compare optimized clusters to labeled data
```{r}

   library (broom)

   attribute <- c("species", "island", "sex")
   
   cluster_compare <- function (attribute) {
      attribute = ensym (attribute)
      kmeans(penguins[5:7], 2) %>%
      augment (penguins) %>%
      rename (cluster = .cluster) %>%
      select (cluster, species, island, sex, id) %>%
      count(!!attribute,cluster) %>%
      ggplot(aes(x=!!attribute, y=cluster, fill = n)) + 
         geom_tile() 
      }

   map (attribute,cluster_compare)
```